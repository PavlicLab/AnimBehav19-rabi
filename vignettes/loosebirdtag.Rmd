---
title: "Tweaking a Coding Scheme: Bird Tagging"
author: "Andrew Burchill"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Tweaking a Coding Scheme: Bird Tagging}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

In this vignette, we will tweak a color coding scheme generated by the `reed_solomon()` function. In our particular hypothetical situation, we plan on putting color bands around the legs of some bird. We have eight different band colors, and we want to put five bands on each bird: two bands below each of the bird's "ankles" (around the tarsometatarsus) and one band above the bird's right "ankle" joint (around the right tibiotarsus). A horrible "graphical" representation can be seen below, where `{1}`, `{2}`, `{3}`, `{4}`, and `{5}` refer to the five unique banding positions.

```{r, echo=FALSE, collapse=TRUE,comment=""}
cat("     |   |            |  {5}\n     o   o            o   o\n     |   |     =>    {1} {3}\n     .   .           {2} {4}\n    /|\\ /|\\          /|\\ /|\\")

```

Let us say that these bands fall off somewhat frequently; we want our coding scheme to be robust to the loss of two bands. If these bands occupy unique positions and can't be moved around, we can use the `reed_solomon()` function without further modification.
```{r, results='hide'}
alphabet <- 8      # the number of colors we have
total_length <- 5  # the number of positions we want band
redundancy <- 2    # how many bands we can lose but still ID perfectly
codes <- rabi::reed_solomon(total_length, redundancy, alphabet)
head(codes, n = 10L)
```
```{r, echo=FALSE}
codes <- t(do.call("cbind",codes))
knitr::kable(head(codes, n = 10L), col.names = c("{1}","{2}","{3}","{4}","{5}"), align = "c", caption = "ID sequences in the unaltered list")
```

Congratualtions! It's as simple as one line of code. **Note that our scheme contains `r dim(codes)[1]` unique IDs.**

##Actually... it's not so simple

Sadly, things get a bit trickier. In reality, these bands may be realtively loose around the legs of the bird. The unique positions of bands `{1}` and `{3}` are probably only maintained due to the physical presence of bands `{2}` and `{4}`. If `{2}` or `{4}` were to somehow be removed, the band above them would succumb to gravity and descend into the newly vacated position. In the below "diagram," we see that a loss of both `{1}` and `{2}` will yield the same final configuration. In this case, it would be impossible to tell the original position of the remaining band. 
```{r, echo=FALSE, collapse=TRUE,comment=""}
cat("     |  {5}           |  {5}           |  {5}\n     o   o            o   o            o   o\n    {1} {3}   AND     x  {3}    =>     |  {3}\n     x  {4}          {2} {4}          {?} {4}\n    /|\\ /|\\          /|\\ /|\\          /|\\ /|\\")
tweaker <- function(combos, redundancy, num.tries = 10, available.colors = NULL) {
  {
    if (missing(redundancy)) {
      stop("Error: you need specify to how many erasure events the IDs should be robust. Note, an increase in robustness requires an increase in the total length of the ID. ")
    }
    # if (redundancy >= total_length || redundancy == 0) {
    #   stop("Error: the code must be robust to at least one erasure. It also cannot be robust to a number of positions equal to or greater than the total length.")
    # }
    if (class(num.tries) != "numeric") {
      stop(paste0("Error: the variable 'num.tries' must be of the class 'numeric,' not '", class(num.tries),".'"))
    }
  }
  #you DON'T generate all sequences, you're given them
  
  
  tester <- function(combos, redundancy) {
    
    combo.list <- split(combos, 1:nrow(combos))
    #pick a random sequence and start making the "safe" list with it
    x <- sample(1:length(combo.list), 1)
    new.combs <- combo.list[x]
    names(new.combs) <- NULL
    #remove everything too similar to the chosen sequence from the old list
    combo.list <- combo.list[stringdist::seq_distmatrix(combo.list, new.combs, method = "hamming")[, length(new.combs)] > redundancy]
    names(combo.list) <- 1:length(combo.list)
    #do this again and again until everything is removed
    while (length(combo.list) > 0) {
      x <- sample(1:length(combo.list), 1)
      new.combs[length(new.combs) + 1] <- (combo.list[x])
      combo.list <- combo.list[stringdist::seq_distmatrix(combo.list, new.combs, method = "hamming")[, length(new.combs)] > redundancy]
      if (length(combo.list) != 0) {
        names(combo.list) <- 1:length(combo.list)
      }
    }
    # print(length(new.combs)) table(unlist(seq_distmatrix(new.combs,new.combs,method='hamming')))
    return(new.combs)
  }
  #run through the function several times and keep the best
  temp1 <- NULL
  temp2 <- 0
  for (i in 1:num.tries) {
    temp1 <- invisible(tester(combos, redundancy))
    if (length(temp1) > length(temp2))
      temp2 <- temp1
  }
  temp2 <- rabi::codes_to_colors(temp2, available.colors)
  return(temp2)
}


```
It becomes clear that a loss in `{1}` would make the ID code **3,4**,2,4,0 indistinguishable from **4,3**,2,4,0 or **5,3**,2,4,0 or **3,0**,2,4,0 etc. (A similar dilemna is caused by losses in `{3}` or `{4}`.)

The best fix for this is not easily apparent. Let's try to work around it just by manipulating our coding scheme.

##Pruning the coding list

One possible idea: prune the list of codes so that the top bands, `{1}` and  `{3}`, are only odd numbers and the bottom bands, `{2}` and  `{4}`, are only even numbers. That way, a lone even-numbered band indicates that the upper band has been lost, etc.

```{r, results='hide',echo=FALSE}
codes <- rabi::reed_solomon(total_length = 5, redundancy = 2, alphabet = 8)
codes <- t(do.call("cbind",codes))  
```
```{r}
 #create a function for determining odd or even
odd <- function(x){ x %% 2 == 1 }
 # only select the codes where {1} and {3} are odd, and {2} and {4} are even
codes <- 
  codes[which(odd(codes[,1]) & odd(codes[,3]) & !odd(codes[,2]) & !odd(codes[,4])), ]
print(paste0("Our new list contains ", dim(codes)[1], " unique IDs."))
```

###Using the `tweaker()` function
Damn. That's almost nothing... However, we can possibly increase that number by using the `tweaker()` function. It's the same as `brute_IDs()`, but instead of pruning down a list of ALL possible ID sequences, we can specify our constraints first and prune down that list.

```{r}
 #create a matrix of all possible sequences
perms <- rep(list(seq_len(alphabet)),total_length)
combos <- as.matrix(expand.grid(perms)) - 1
 #only keep sequences that fit our constraints
combos <- 
  combos[which(odd(combos[,1]) & odd(combos[,3]) & !odd(combos[,2]) & !odd(combos[,4])), ]
codes <- tweaker(combos, redundancy, num.tries = 1)  #we're only running it once for speed
print(paste0("The 'tweaked' list contains ", length(codes), " unique IDs."))

```

```{r}
 #create a matrix of all possible sequences
perms <- rep(list(seq_len(alphabet)),total_length)
combos <- as.matrix(expand.grid(perms)) - 1
 #only keep sequences that fit our constraints
combos <- 
  combos[which(odd(combos[,1]) & !odd(combos[,2])), ]
codes <- tweaker(combos, redundancy, num.tries = 1)  #we're only running it once for speed
print(paste0("The 'tweaked' list contains ", length(codes), " unique IDs."))

```

Okay, that's still not much better... To really make this work, we'll probably need to change the physical setup of the tagging system.

##Physical changes

A very simple solution: on the upper color bands `{1}` and `{3}`, use a sharpie to add dark vertical stripes. Adding additional markings can give the banding positions uniqueness in the face of gravity and detachment. However, one could imagine many reasons why such a last-minute fix would not be ideal.

```{r}
 #create a matrix of all possible sequences
perms <- rep(list(seq_len(alphabet)),total_length)
combos <- as.matrix(expand.grid(perms)) - 1

combos <- combos[which((
      (odd(combos[,1]) & odd(combos[,3]) & !odd(combos[,2]) & !odd(combos[,4])) |
      (!odd(combos[,1]) & !odd(combos[,3]) & odd(combos[,2]) & odd(combos[,4]))
      )), ]
codes <- tweaker(combos, redundancy, num.tries = 1)  #we're only running it once for speed
print(paste0("The 'tweaked' list contains ", length(codes), " unique IDs."))

```


Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
